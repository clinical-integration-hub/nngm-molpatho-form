/// version = 0.1
/// title = "CTSBeurteilung"

/* TO DO
- Missing repeat sections
*/

map "http://uk-koeln.de/fhir/StructureMap/CTSBeurteilung" = CTSBeurteilung

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

group TransformCTS(source src: Bundle, target tgt: CTS_Transport)
{
    src -> tgt.version = '1.1';
    src -> tgt.sourcesystem = 'https:\/\/nngm-qat.staging.healex.systems\/'; 
    src -> tgt.operations as operations collate, operations.crfid = '1-BU';
    src -> tgt.operations as operations collate, operations.type = 'save';
    
    //Observation
    src.entry as entry then 
    {

    /* ------------------------------ DiagnosticReport ---------------------------- */
    entry.resource as diagnosticreport where "resource is DiagnosticReport" then
    {
        //Erstelldatum
        diagnosticreport -> tgt.operations as operations collate then
        {
            diagnosticreport -> operations.data as data then
            {
                diagnosticreport.effectiveDateTime as dt then
                {   
                    diagnosticreport -> data.blockindex = 0;
                    diagnosticreport -> data.groupindex = 0;
                    diagnosticreport -> data.itemid = 'bu_creation_date';
                    dt -> data.values as values, values.value = dt;
                };
            };
        };

        //Version
        diagnosticreport -> tgt.operations as operations collate then
        {
            diagnosticreport -> operations.data as data then
            {
                diagnosticreport.status as status then
                {   
                    diagnosticreport -> data.blockindex = 0;
                    diagnosticreport -> data.groupindex = 0;
                    diagnosticreport -> data.itemid = 'bu_version';
                    status -> data.values as values, values.value = status;
                };
            };
        };


        //Klinische Information
        diagnosticreport -> tgt.operations as operations collate then
        {
            diagnosticreport -> operations.data as data then
            {
                diagnosticreport.conclusion as conclusion then
                {   
                    diagnosticreport -> data.blockindex = 0;
                    diagnosticreport -> data.groupindex = 0;
                    diagnosticreport -> data.itemid = 'id_1352';
                    conclusion -> data.values as values, values.value = conclusion;
                };
            };
        };

        //Empfehlung einer systemischen Therapie
        diagnosticreport -> tgt.operations as operations collate then
        {
            diagnosticreport -> operations.data as data then
            {
                diagnosticreport.conclusionCode as conclusionCode, conclusionCode.extension as beurteilung, beurteilung.valueBoolean as empfehlung where "$this.value = true" then
                {   
                    diagnosticreport -> data.blockindex = 0;
                    diagnosticreport -> data.groupindex = 0;
                    diagnosticreport -> data.itemid = 'id_2405';
                    empfehlung -> data.values as values, values.value = 'Ja';
                };

                diagnosticreport.conclusionCode as conclusionCode, conclusionCode.extension as beurteilung, beurteilung.valueBoolean as empfehlung where "$this.value = false" then
                {   
                    diagnosticreport -> data.blockindex = 0;
                    diagnosticreport -> data.groupindex = 0;
                    diagnosticreport -> data.itemid = 'id_2405';
                    empfehlung -> data.values as values, values.value = 'Nein';
                };
            };
        };
    };
    
    /* ------------------------------ ServiceRequest ----------------------------*/ 
    entry.resource as servicerequest where "resource is ServiceRequest" then
    {   
            //Patient ID -> cts.patid
             servicerequest -> tgt.operations as operations collate then
            {
                servicerequest -> operations.data as data then
                {
                    servicerequest.subject as subject then
                    {   
                        subject.reference as patient then
                        {
                            patient -> tgt.patid = evaluate(patient, '$this.split(\'\/\').last()');
                        };
                    };
                };
            };

            //Durchfuerung
            servicerequest -> tgt.operations as operations collate then
            {
                servicerequest -> operations.data as data then 
                {
                    servicerequest.status as durchfuerung then
                    {
                        servicerequest -> data.blockindex = 1;
                        servicerequest -> data.groupindex = 0;
                        servicerequest -> data.itemid = 'id_2523';
                        durchfuerung -> data.values as values, values.value = durchfuerung;
                    };
                };
            };

            //Abschluss 
            servicerequest -> tgt.operations as operations collate then
            {
                servicerequest -> operations.data as data then 
                {
                    servicerequest.category as abschluss, abschluss.category as category, category.coding as coding, coding.code as abschluss then
                    {
                        servicerequest -> data.blockindex = 1;
                        servicerequest -> data.groupindex = 0;
                        servicerequest -> data.itemid = 'bu_closing';
                        abschluss -> data.values as values, values.value = abschluss;
                    };
                };
            };
            

            //Datum des abschlusses 
            servicerequest -> tgt.operations as operations collate then
            {
                servicerequest -> operations.data as data then 
                {
                    servicerequest.extension as extension, extension.valueDateTime as datumAbschlusses  where "$this.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/datumabschluss'" then
                    {
                        servicerequest -> data.blockindex = 1;
                        servicerequest -> data.groupindex = 0;
                        servicerequest -> data.itemid = 'id_2524';
                        datumAbschlusses -> data.values as values, values.value = datumAbschlusses;
                    };
                };
            };

            //Datum des versands 
            servicerequest -> tgt.operations as operations collate then
            {
                servicerequest -> operations.data as data then 
                {
                    servicerequest.extension as extension, extension.valueDateTime as datumVersands where "$this.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/datumversands'" then
                    {
                        servicerequest -> data.blockindex = 1;
                        servicerequest -> data.groupindex = 0;
                        servicerequest -> data.itemid = 'id_2525';
                        datumVersands -> data.values as values, values.value = datumVersands;
                    };
                };
            };
        };
    };
}
